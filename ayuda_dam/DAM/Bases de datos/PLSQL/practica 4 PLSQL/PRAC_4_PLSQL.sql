   /**********************************   *    PRACTICA Nº4 DE PL-SQL       *   *    MANUEL GUTIERREZ TORRERO     *   *    1º DAM                       *   ***********************************   */   /* PRACTICA QUE TRATA SOBRE CURSORES*/  /*CREACION DE TABLAS Y SECUENCIAS*//*CREATE SEQUENCE S_MARCA  INCREMENT BY 1  START WITH 1  MINVALUE 1  MAXVALUE 999  CYCLE  ORDER  NOCACHE;  CREATE SEQUENCE S_COMISION  INCREMENT BY 1  START WITH 1  MINVALUE 1  MAXVALUE 999  CYCLE  ORDER  NOCACHE;CREATE TABLE MARCA(  IDEMAR NUMBER(3),  NOMMAR VARCHAR2(15),  CONSTRAINT PK_MARCA PRIMARY KEY(IDEMAR));  CREATE TABLE CLIENTE(   DNICLI VARCHAR2(15),   NOMCLI VARCHAR2(10),   APE1 VARCHAR2(10),   APE2 VARCHAR2(10),   DIR VARCHAR2(25),   TEL VARCHAR2(10),   CONSTRAINT PK_CLIENTE PRIMARY KEY (DNICLI));   CREATE TABLE COMERCIAL(   DNICOM VARCHAR2(15),   NOMCOM VARCHAR2(10),   APE1 VARCHAR2(10),   APE2 VARCHAR2(10),   DIR VARCHAR2(25),   TEL VARCHAR2(10),   SUELDO NUMBER(6,2),   COMISION NUMBER(6,2),   BORRADO NUMBER(1),   CONSTRAINT PK_COMERCIAL PRIMARY KEY (DNICOM));CREATE TABLE COMISION(   IDECOM NUMBER(3),   DNICOM VARCHAR2(15),   PRECIO NUMBER(10,2),      COMISION NUMBER(10,2),   CANTIDAD NUMBER(10,2),   FECHA DATE,   CONSTRAINT PK_COMISION PRIMARY KEY (IDECOM),   CONSTRAINT FK_COMISION_COMERCIAL FOREIGN KEY (DNICOM) REFERENCES COMERCIAL (DNICOM));CREATE TABLE VEHICULO(  MATRI VARCHAR2(10),  IDEMAR NUMBER(3),  DNICLI VARCHAR2(15),  DNICOM VARCHAR2(15),  DETALLE VARCHAR2(40),  PRECIO NUMBER(10,2),  VENDIDO NUMBER(1),  PROCESADO NUMBER(1),  CONSTRAINT PK_VEHICULO PRIMARY KEY(IDEMAR),  CONSTRAINT FK_VEHICULO_MARCA FOREIGN KEY (IDEMAR) REFERENCES MARCA (IDEMAR),  CONSTRAINT FK_VEHICULO_CLIENTE FOREIGN KEY (DNICLI) REFERENCES CLIENTE (DNICLI),  CONSTRAINT FK_VEHICULO_COMERCIAL FOREIGN KEY (DNICOM) REFERENCES COMERCIAL (DNICOM));    -- APARTADO INSERTSINSERT INTO MARCA (IDEMAR,NOMMAR) VALUES (S_MARCA.NEXTVAL,'MAR1');INSERT INTO MARCA (IDEMAR,NOMMAR) VALUES (S_MARCA.NEXTVAL,'MAR2');INSERT INTO MARCA (IDEMAR,NOMMAR) VALUES (S_MARCA.NEXTVAL,'MAR3');   INSERT INTO CLIENTE (DNICLI,NOMCLI,APE1,APE2,DIR,TEL) VALUES ('DNI1','NOMCLI1','APE1','APE2','CALLE DE LAS ROSAS','2314556');INSERT INTO CLIENTE (DNICLI,NOMCLI,APE1,APE2,DIR,TEL) VALUES ('DNI2','NOMCLI1','APE1','APE2','CALLE DE LAS ROSAS','2314556');INSERT INTO CLIENTE (DNICLI,NOMCLI,APE1,APE2,DIR,TEL) VALUES ('DNI3','NOMCLI1','APE1','APE2','CALLE DE LAS ROSAS','2314556');INSERT INTO CLIENTE (DNICLI,NOMCLI,APE1,APE2,DIR,TEL) VALUES ('DNI4','NOMCLI1','APE1','APE2','CALLE DE LAS ROSAS','2314556');INSERT INTO COMERCIAL (DNICOM,NOMCOM,APE1,APE2,DIR,TEL,SUELDO,COMISION,BORRADO) VALUES                ('DNI5','NOMCLI1','APE1','APE2','CALLE DE LAS ROSAS','2314556',1000.23,100.09,0);INSERT INTO COMERCIAL (DNICOM,NOMCOM,APE1,APE2,DIR,TEL,SUELDO,COMISION,BORRADO) VALUES                ('DNI6','NOMCLI1','APE1','APE2','CALLE DE LAS ROSAS','2314556',2000.23,100.09,0);INSERT INTO COMERCIAL (DNICOM,NOMCOM,APE1,APE2,DIR,TEL,SUELDO,COMISION,BORRADO) VALUES                ('DNI7','NOMCLI1','APE1','APE2','CALLE DE LAS ROSAS','2314556',1900.23,100.09,0);INSERT INTO COMERCIAL (DNICOM,NOMCOM,APE1,APE2,DIR,TEL,SUELDO,COMISION,BORRADO) VALUES                ('DNI8','NOMCLI1','APE1','APE2','CALLE DE LAS ROSAS','2314556',1800.23,100.09,0);			   			   INSERT INTO COMISION (IDECOM,DNICOM,PRECIO,COMISION,CANTIDAD,FECHA) VALUES (S_COMISION.NEXTVAL,'DNI5',9876.45,100.09,1,'09/07/2013');	INSERT INTO COMISION (IDECOM,DNICOM,PRECIO,COMISION,CANTIDAD,FECHA) VALUES (S_COMISION.NEXTVAL,'DNI5',9876.45,100.09,1,'09/07/2013');	INSERT INTO COMISION (IDECOM,DNICOM,PRECIO,COMISION,CANTIDAD,FECHA) VALUES (S_COMISION.NEXTVAL,'DNI5',9876.45,100.09,1,'09/07/2013');		INSERT INTO COMISION (IDECOM,DNICOM,PRECIO,COMISION,CANTIDAD,FECHA) VALUES (S_COMISION.NEXTVAL,'DNI5',9876.45,100.09,1,'09/07/2013');		     INSERT INTO VEHICULO (MATRI,IDEMAR,DNICLI,DNICOM,DETALLE,PRECIO,VENDIDO,PROCESADO) VALUES ('M1234A',1,'DNI1','DNI5','DET1',10000,1,0);INSERT INTO VEHICULO (MATRI,IDEMAR,DNICLI,DNICOM,DETALLE,PRECIO,VENDIDO,PROCESADO) VALUES ('M2345A',2,'DNI2','DNI5','DET1',10000,1,1);INSERT INTO VEHICULO (MATRI,IDEMAR,DNICLI,DNICOM,DETALLE,PRECIO,VENDIDO,PROCESADO) VALUES ('M6789A',3,'DNI3','DNI5','DET1',10000,1,0);COMMIT;*/  /*EJERCICIO 1*//*CREATE SEQUENCE S_PERSONAL  INCREMENT BY 1  START WITH 1  MINVALUE 1  MAXVALUE 999  CYCLE  ORDER  NOCACHE;CREATE TABLE PERSONAL(  IDEPER NUMBER(3),  CONTENIDO VARCHAR2(100));INSERT INTO PERSONAL (IDEPER,CONTENIDO) VALUES (S_PERSONAL.NEXTVAL,'11111111#PEDRO#ALONSO#GARCIA#C/ LAS MOSCAS 33#111111111#1000#5#');INSERT INTO PERSONAL (IDEPER,CONTENIDO) VALUES (S_PERSONAL.NEXTVAL,'22222222#JOSE#RECIO#LORCA#C/ OSOS 15#222222222#1200#7#');INSERT INTO PERSONAL (IDEPER,CONTENIDO) VALUES (S_PERSONAL.NEXTVAL,'33333333#NULL#NULL#NULL#NULL#NULL#NULL#NULL#');COMMIT;*/SET SERVEROUTPUT ON FORMAT WORD_WRAPPED;DECLARE   TEXTO PERSONAL.CONTENIDO%TYPE;  CAMPO VARCHAR2(100);  M NUMBER(2):=1;  N NUMBER(2):=0;  NUM NUMBER(2):=1;  IND NUMBER(2):=0;  CONT NUMBER(2):=0;  TYPE TIPO_LISTA IS TABLE OF COMERCIAL%ROWTYPE INDEX BY BINARY_INTEGER;  CURSOR CURPER IS SELECT CONTENIDO FROM PERSONAL;  LISTA_PER TIPO_LISTA;BEGIN      OPEN  CURPER;      FETCH  CURPER INTO TEXTO;   WHILE (CURPER%FOUND) LOOP      DBMS_OUTPUT.PUT_LINE('PERSONA: '||NUM);      FOR N IN 1..9 LOOP	       	       SELECT INSTR(TEXTO,'#', M, 1) INTO IND FROM DUAL;         CAMPO:=SUBSTR(TEXTO,M,(IND-M));	       M:=IND+1;         CASE            WHEN N=1 THEN                  LISTA_PER(NUM).DNICOM:=CAMPO;	                DBMS_OUTPUT.PUT_LINE('DNI: '||CAMPO);            WHEN N=2 THEN                 LISTA_PER(NUM).NOMCOM:=CAMPO;	               DBMS_OUTPUT.PUT_LINE('NOMBRE: '||CAMPO);            WHEN N=3 THEN                  LISTA_PER(NUM).APE1:=CAMPO;	                DBMS_OUTPUT.PUT_LINE('APE1: '||CAMPO);            WHEN N=4 THEN                 LISTA_PER(NUM).APE2:=CAMPO;	               DBMS_OUTPUT.PUT_LINE('APE2: '||CAMPO);            WHEN N=5 THEN                  LISTA_PER(NUM).DIR:=CAMPO;	                DBMS_OUTPUT.PUT_LINE('DIR: '||CAMPO);            WHEN N=6 THEN                 LISTA_PER(NUM).TEL:=CAMPO;	               DBMS_OUTPUT.PUT_LINE('TEL: '||CAMPO);            WHEN N=7 THEN            IF(CAMPO!='NULL') THEN                 LISTA_PER(NUM).SUELDO:=TO_NUMBER(CAMPO);            END IF;	                DBMS_OUTPUT.PUT_LINE('SUELDO: '||CAMPO);            WHEN N=8 THEN            IF(CAMPO!='NULL') THEN                 LISTA_PER(NUM).COMISION:=TO_NUMBER(CAMPO);            END IF;	               DBMS_OUTPUT.PUT_LINE('COMISION: '||CAMPO);            ELSE                 DBMS_OUTPUT.PUT_LINE('NADA');        END CASE;		    END LOOP;      SELECT COUNT(*) INTO CONT FROM COMERCIAL WHERE (DNICOM=LISTA_PER(NUM).DNICOM);      IF(CONT>0) THEN          IF(LISTA_PER(NUM).NOMCOM='NULL') THEN             DBMS_OUTPUT.PUT_LINE('BAJA LOGICA');             UPDATE COMERCIAL SET BORRADO=1 WHERE (DNICOM=LISTA_PER(NUM).DNICOM);          ELSE            UPDATE COMERCIAL SET SUELDO=LISTA_PER(NUM).SUELDO WHERE (DNICOM=LISTA_PER(NUM).DNICOM);            UPDATE COMERCIAL SET COMISION=LISTA_PER(NUM).COMISION WHERE (DNICOM=LISTA_PER(NUM).DNICOM);          END IF;      ELSE            IF(LISTA_PER(NUM).NOMCOM!='NULL') THEN             INSERT INTO COMERCIAL (DNICOM,NOMCOM,APE1,APE2,DIR,TEL,SUELDO,COMISION,BORRADO) VALUES                (LISTA_PER(NUM).DNICOM,LISTA_PER(NUM).NOMCOM,LISTA_PER(NUM).APE1,LISTA_PER(NUM).APE2               ,LISTA_PER(NUM).DIR,LISTA_PER(NUM).TEL,LISTA_PER(NUM).SUELDO,LISTA_PER(NUM).COMISION,0);          ELSE            DBMS_OUTPUT.PUT_LINE('ERROR');          END IF;      END IF;           NUM:=NUM+1;      CONT:=0;           FETCH  CURPER INTO TEXTO;   END LOOP;      CLOSE CURPER;   DELETE FROM PERSONAL;END;//*FIN DE EJERCICIO 1*//*EJERCICIO 2*/SET SERVEROUTPUT ON FORMAT WORD_WRAPPED;DECLARE   CURSOR CURVEH IS SELECT * FROM  VEHICULO WHERE (VENDIDO=1 AND PROCESADO=0);  CVEH VEHICULO%ROWTYPE;  COM COMISION.COMISION%TYPE;  CANT COMISION.CANTIDAD%TYPE;BEGIN   OPEN CURVEH;    FETCH CURVEH INTO CVEH;    WHILE(CURVEH%FOUND)LOOP            DBMS_OUTPUT.PUT_LINE('COMISION INSERTADA');          COM:=10;          CANT:=(CVEH.PRECIO*COM)/100;        INSERT INTO COMISION (IDECOM,DNICOM,PRECIO,COMISION,CANTIDAD,FECHA) VALUES (S_COMISION.NEXTVAL,CVEH.DNICOM,CVEH.PRECIO,COM,CANT,SYSDATE);        UPDATE VEHICULO SET PROCESADO=1 WHERE DNICOM=CVEH.DNICOM;        FETCH CURVEH INTO CVEH;    END LOOP;  CLOSE CURVEH;END;//*FIN DE EJERCICIO 2*/--EJERCICIO 3/* TABLAS SECUENCIAS E INSERT EJERCICIO 3CREATE SEQUENCE S_REMENSA  INCREMENT BY 1  START WITH 1  MINVALUE 1  MAXVALUE 999  CYCLE  ORDER  NOCACHE;  CREATE TABLE REMENSA(  IDEPER NUMBER(3),  CONTENIDO VARCHAR2(100)); INSERT INTO REMENSA (IDEPER,CONTENIDO) VALUES (S_REMENSA.NEXTVAL,'Citroen#1234BNJ#C8-Azul-2.5Diesel#20000#');INSERT INTO REMENSA (IDEPER,CONTENIDO) VALUES (S_REMENSA.NEXTVAL,'Renault#4321ABC#Clio-Rojo-1.5Gasolina#7000#');COMMIT;*/SET SERVEROUTPUT ON FORMAT WORD_WRAPPED;DECLARE   TEXTO REMENSA.CONTENIDO%TYPE;  CAMPO VARCHAR2(100);  M NUMBER(2):=1;  N NUMBER(2):=0;  NUM NUMBER(2):=1;  IND NUMBER(2):=0;  CONT NUMBER(2):=0;  SUMARCA MARCA.IDEMAR%TYPE;  TYPE TIPO_LISTA IS TABLE OF VEHICULO%ROWTYPE INDEX BY BINARY_INTEGER;  CURSOR CURREM IS SELECT CONTENIDO FROM REMENSA;  LISTA_REM TIPO_LISTA;BEGIN      OPEN  CURREM;      FETCH  CURREM INTO TEXTO;   WHILE (CURREM%FOUND) LOOP      --DBMS_OUTPUT.PUT_LINE('REMENSA: '||NUM);      FOR N IN 1..4 LOOP	       	       SELECT INSTR(TEXTO,'#', M, 1) INTO IND FROM DUAL;         CAMPO:=SUBSTR(TEXTO,M,(IND-M));	       M:=IND+1;         CASE            WHEN N=1 THEN                  SELECT COUNT(*) INTO CONT FROM MARCA WHERE NOMMAR=CAMPO;                   DBMS_OUTPUT.PUT_LINE('CONT: '||CONT);                  IF(CONT=0)THEN                    INSERT INTO MARCA (IDEMAR,NOMMAR) VALUES (S_MARCA.NEXTVAL,CAMPO);                  END IF;                  SELECT IDEMAR INTO SUMARCA FROM MARCA WHERE NOMMAR=CAMPO;	                DBMS_OUTPUT.PUT_LINE('Marca: '||CAMPO);            WHEN N=2 THEN                 LISTA_REM(NUM).MATRI:=CAMPO;	               DBMS_OUTPUT.PUT_LINE('Matricula: '||CAMPO);            WHEN N=3 THEN                  LISTA_REM(NUM).DETALLE:=CAMPO;	                DBMS_OUTPUT.PUT_LINE('Detalle: '||CAMPO);                       WHEN N=4 THEN                                    LISTA_REM(NUM).PRECIO:=CAMPO;                  DBMS_OUTPUT.PUT_LINE('Precio: '||CAMPO);        END CASE;	      	    END LOOP;      INSERT INTO VEHICULO (MATRI,IDEMAR,DNICLI,DNICOM,DETALLE,PRECIO,VENDIDO,PROCESADO) VALUES (LISTA_REM(NUM).MATRI,SUMARCA,NULL,NULL,LISTA_REM(NUM).DETALLE,LISTA_REM(NUM).PRECIO,0,0);      COMMIT;      NUM:=NUM+1;      CONT:=0;      M:=1;      IND:=0;      CAMPO:='';      TEXTO:='';      FETCH CURREM INTO TEXTO;      END LOOP;  CLOSE CURREM;END;//*FIN DE EJERCICIO 3*/